######################################################################
# Dual CPU + GPU Makefile for KLT
######################################################################

CC      = gcc
NVC     = nvc
NVCXX   = nvc++
NVCC    = nvcc
AR      = ar

CFLAGS      = -O3 -DNDEBUG -fPIC -Wall
ACCFLAGS    = -O3 -acc -gpu=cc75 -DNDEBUG -fPIC
NVCCFLAGS   = -O3 -std=c++14 -arch=sm_75 -DNDEBUG -Xcompiler -fPIC

LIBS_CPU = -lm
LIBS_GPU = -lm -lcudart

COMMON_C = error.c pnmio.c pyramid.c storeFeatures.c klt.c klt_util.c writeFeatures.c selectGoodFeatures.c
EXAMPLES = example1.c example2.c example3.c example4.c example5.c

CPU_SRC  = convolve.c  trackFeatures.c $(COMMON_C)

# GPU sources
GPU_CU   = trackFeatures.cu                   # CUDA kernel â†’ nvcc
GPU_OPT  =            convolve_opt.c                      # OpenACC â†’ nvc
GPU_C    = $(filter-out convolve.c  trackFeatures.c, $(COMMON_C))

OBJDIR_CPU = obj_cpu
OBJDIR_GPU = obj_gpu

######################################################################
# CPU Build
######################################################################
CPU_OBJS = $(addprefix $(OBJDIR_CPU)/,$(CPU_SRC:.c=.o))
CPU_LIB  = libklt_cpu.a
CPU_EXES = $(EXAMPLES:.c=_CPU)

.PHONY: cpu
cpu: $(CPU_LIB) $(CPU_EXES)
	@echo "âœ… CPU build complete!"

$(CPU_LIB): $(CPU_OBJS)
	$(AR) rcs $@ $^

%_CPU: %.c $(CPU_LIB)
	$(CC) $(CFLAGS) -o $@ $< -L. -lklt_cpu $(LIBS_CPU)

######################################################################
# GPU Build
######################################################################
GPU_OBJS = \
	$(addprefix $(OBJDIR_GPU)/,$(GPU_CU:.cu=.o)) \
	$(addprefix $(OBJDIR_GPU)/,$(GPU_OPT:.c=.o)) \
	$(addprefix $(OBJDIR_GPU)/,$(GPU_C:.c=.o))

GPU_LIB  = libklt_gpu.a
GPU_EXES = $(EXAMPLES:.c=_GPU)

.PHONY: gpu
gpu: $(GPU_LIB) $(GPU_EXES)
	@echo "ðŸš€ GPU build complete!"

$(GPU_LIB): $(GPU_OBJS)
	$(AR) rcs $@ $^

# FINAL GPU LINKING â†’ MUST use nvc++ (NOT nvcc)
%_GPU: %.c $(GPU_LIB)
	$(NVCXX) $(ACCFLAGS) -DUSE_GPU -o $@ $< -L. -lklt_gpu $(LIBS_GPU)

######################################################################
# Compilation Rules
######################################################################
.SUFFIXES: .cu .c .o

# CUDA kernel (nvcc)
$(OBJDIR_GPU)/%.o: %.cu
	@mkdir -p $(OBJDIR_GPU)
	$(NVCC) $(NVCCFLAGS) -DUSE_GPU -c $< -o $@

# OpenACC optimized sources â†’ nvc
$(OBJDIR_GPU)/selectGoodFeatures_opt.o: selectGoodFeatures_opt.c
	@mkdir -p $(OBJDIR_GPU)
	$(NVC) $(ACCFLAGS) -DUSE_GPU -c $< -o $@

$(OBJDIR_GPU)/convolve_opt.o: convolve_opt.c
	@mkdir -p $(OBJDIR_GPU)
	$(NVC) $(ACCFLAGS) -DUSE_GPU -c $< -o $@

# Other GPU C files â†’ gcc (normal C)
$(OBJDIR_GPU)/%.o: %.c
	@mkdir -p $(OBJDIR_GPU)
	$(CC) $(CFLAGS) -DUSE_GPU -c $< -o $@

# CPU C files â†’ gcc
$(OBJDIR_CPU)/%.o: %.c
	@mkdir -p $(OBJDIR_CPU)
	$(CC) $(CFLAGS) -c $< -o $@

######################################################################
# Clean
######################################################################
.PHONY: clean
clean:
	rm -rf $(OBJDIR_CPU) $(OBJDIR_GPU)
	rm -f *.a *_CPU *_GPU feat.ppm features.* *.tar *.tar.gz
	@echo "ðŸ§¹ Cleaned all build files."

